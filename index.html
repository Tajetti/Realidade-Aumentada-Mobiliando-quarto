<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0">
<title>AR Furniture</title>

<script src="https://unpkg.com/three@0.126.0/build/three.js"></script>
<script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>

<style>
#ar-menu {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.6);
  padding: 15px;
  display: flex;
  gap: 15px;
  border-radius: 12px;
  backdrop-filter: blur(6px);
  z-index: 9999;
  display: none;
}
#ar-menu button {
  padding: 10px 14px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  background: white;
  cursor: pointer;
}
#startButton {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 20px;
  font-size: 18px;
  border-radius: 12px;
  background: #007bff;
  color: white;
  border: none;
  z-index: 9999;
}
</style>

</head>
<body>

<button id="startButton" onclick="activateXR()">Start AR</button>

<div id="ar-menu">
  <button onclick="selectedModel='models/cama.glb'">Cama</button>
  <button onclick="selectedModel='models/sofa.glb'">Sofá</button>
  <button onclick="selectedModel='models/armario.glb'">Armário</button>
</div>

<script>
let scene, renderer, camera;
let loader = new THREE.GLTFLoader();
let reticle;
let hitTestSource = null;
let hitTestSourceRequested = false;
let selectedModel = null;

async function activateXR() {

  document.getElementById("startButton").style.display = "none";
  document.getElementById("ar-menu").style.display = "flex";

  // THREE scene
  scene = new THREE.Scene();

  // ⭐⭐⭐ ADICIONANDO LUZES PARA MODELOS NÃO FICAREM PRETOS ⭐⭐⭐
  const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.4);
  scene.add(light);

  const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
  directionalLight.position.set(1, 2, 1);
  scene.add(directionalLight);

  camera = new THREE.PerspectiveCamera();
  camera.matrixAutoUpdate = false;
  scene.add(camera);  // ← obrigatório

  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  renderer.xr.setReferenceSpaceType("local-floor");
  document.body.appendChild(renderer.domElement);

  // RETICLE (bolinha azul)
  reticle = new THREE.Mesh(
    new THREE.RingGeometry(0.08, 0.09, 32).rotateX(-Math.PI / 2),
    new THREE.MeshBasicMaterial({ color: 0x00aaff })
  );
  reticle.visible = false;
  scene.add(reticle);

  // XR SESSION
  const session = await navigator.xr.requestSession("immersive-ar", {
    requiredFeatures: ["hit-test", "local-floor", "dom-overlay"],
    domOverlay: { root: document.body }
  });
  renderer.xr.setSession(session);

  const referenceSpace = await session.requestReferenceSpace("local-floor");
  const viewerSpace = await session.requestReferenceSpace("viewer");

  // Colocar objeto ao tocar na tela
  session.addEventListener("select", () => {
    if (selectedModel && reticle.visible) {
      loader.load(selectedModel, (gltf) => {
        const model = gltf.scene;
        model.position.copy(reticle.position);
        model.quaternion.copy(reticle.quaternion);
        model.scale.set(0.4, 0.4, 0.4);
        scene.add(model);
      });
    }
  });

  const onXRFrame = (time, frame) => {
    session.requestAnimationFrame(onXRFrame);

    const viewerPose = frame.getViewerPose(referenceSpace);
    if (!viewerPose) return;

    if (!hitTestSourceRequested) {
      session.requestHitTestSource({ space: viewerSpace })
        .then(source => hitTestSource = source);
      hitTestSourceRequested = true;
    }

    if (hitTestSource) {
      const results = frame.getHitTestResults(hitTestSource);

      if (results.length > 0) {
        const hit = results[0];
        const pose = hit.getPose(referenceSpace);

        reticle.visible = true;
        reticle.position.set(
          pose.transform.position.x,
          pose.transform.position.y,
          pose.transform.position.z
        );
        reticle.quaternion.set(
          pose.transform.orientation.x,
          pose.transform.orientation.y,
          pose.transform.orientation.z,
          pose.transform.orientation.w
        );
      } else {
        reticle.visible = false;
      }
    }

    renderer.render(scene, camera);
  };

  session.requestAnimationFrame(onXRFrame);
}
</script>

</body>
</html>
